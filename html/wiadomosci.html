<!doctype html>
<html lang="pl">
	<head>
		<script src="/js/jquery.min.js"></script>
		<script src="/js/main.js"></script>
		<script>
			setTimeout(function(){$('body').animate({opacity:'1'},500)},400);
			if (getCookie("token") == null) {
				document.location.href = "/logowanie.html";
				document.body.innerHTML = "";
				window.stop();
			} else {
				var userdata = {
					"id" : parseInt(getCookie("id")),
					"id_uprawnien" : parseInt(getCookie("id_uprawnienie"))
				}

				if (userdata.id_uprawnien < 1){ // minimalny poziom uprawnień (zabezpieczenie api osobno)
					document.location.href = "/";
					document.body.innerHTML = "";
					window.stop();
				}
			}
		</script>
		<meta charset="utf-8">
		<title>System obsługi studentów</title>
		<meta name="description" content="System Obsługi Studentów">
		<link rel="stylesheet" href="/css/navbar.css">
		<link rel="stylesheet" href="/css/modal.css">
		<link rel="stylesheet" href="/css/main.css">
	</head>
	<body>
		<div class="navbar">
			<a id="menu-strona" href="/">Strona główna</a>
			<div id="dropdown-wiadomosci" class="dropdown">
				<button class="dropbtn">
					<span>Wiadomości</span> 
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-wiadomosci-skrzynka" href="/wiadomosci.html"><span>Skrzynka odbiorcza</span></a>
					<a id="dropdown-wiadomosci-utworz" href="/wiadomosc_nowa.html"><span>Utwórz wiadomość</span></a>
				</div>
			</div>
			<a id="menu-ogloszenia" href="/ogloszenia.html">Zarządzanie ogłoszeniami</a>
			<div id="dropdown-uzytkownicy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie użytkownikami</span> 
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-uzytkownicy-lista" href="#"><span class="disabled">Lista użytkowników</span></a>
					<a id="dropdown-uzytkownicy-utworz" href="#"><span class="disabled">Utwórz użytkownika</span></a>
				</div>
			</div>
			<div id="dropdown-zapisy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie zapisami</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-zapisy-utworz" href="#"><span class="disabled">Tworzenie zapisów</span></a>
					<a id="dropdown-zapisy-edycja" href="#"><span class="disabled">Edycja zapisów</span></a>
				</div>
			</div>
			<a id="menu-zapisy" href="/"><span class="disabled">Zapisy</span></a>
			<div id="dropdown-kursyz" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie kursami</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-kursyz-lista" href="#"><span class="disabled">Lista kursów</span></a>
					<a id="dropdown-kursyz-utworz" href="#"><span class="disabled">Utwórz nowy kurs</span></a>
				</div>
			</div>
			<div id="dropdown-kursy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Kursy</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-kursy-zajecia" href="#"><span class="disabled">Zajęcia</span></a>
					<a id="dropdown-kursy-oceny" href="#"><span class="disabled">Oceny</span></a>
				</div>
			</div>
			<a id="menu-indeks" href="/"><span class="disabled">Indeks</span></a>
			<div id="dropdown-sprawy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Sprawy</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-sprawy-moje" href="#"><span class="disabled">Moje sprawy</span></a>
					<a id="dropdown-sprawy-utworz" href="#"><span class="disabled">Załóż sprawę</span></a>
				</div>
			</div>
			<div id="dropdown-sprawyz" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzaj sprawami</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-sprawyz-lista" href="#"><span class="disabled">Przeglądaj sprawy</span></a>
					<a id="dropdown-sprawyz-utworz" href="#"><span class="disabled">Definiuj sprawy</span></a>
				</div>
			</div>
			<div class="dropdown-right">
				<button class="dropbtn">
					<span id="auth-imie">Imie</span> <span id="auth-nazwisko">Nazwisko</span> (<span id="auth-ranga">Ranga</span>)
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a href="#"><span class="disabled">Dane osobowe</span></a>
					<a href="#"><span class="disabled">Ustawienia</span></a>
					<a id="wyloguj_navbar" href="/wyloguj.html">Wyloguj</a>
				</div>
			</div>
		</div>
		<div class="content">
			<div class="header">
				<h2>Skrzynka odbiorcza</h2>
				<a href="/wiadomosc_nowa.html"><button>Nowa wiadomość</button></a></br></br>
			</div>
			<table id="odpowiedzAJAX">
				<tr>
					<td>ID</td>
					<td>Nadawca</td>
					<td>Data</td>
					<td>Temat</td>
				</tr>
			</table>
		</div>

		<div id="modalWiadomosc" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<span id="modalZamknij" class="close">&times;</span>
					<h2 id='modalWiadomoscTytul'></h2>
				</div>
				<div class="modal-body">
					<p id='modalWiadomoscNadawca'></p>
					<p id='modalWiadomoscData'></p>
					<p id='modalWiadomoscTresc'></p>
				</div>
			</div>
		</div>
		
		<script src="/js/nav.js"></script>
		<script>
			$.ajax({
				url: '/api/wiadomosci/domnie',
				type: "POST",
				data: JSON.stringify(uzytkownik_id),
				contentType: "application/json; charset=UTF-8",
				success: function (data) {
					if (data.status != 200){
						if (data.status == 401){
							wyloguj();
						}
					} else if (data.status == 200){
                        var wiadomosci_id_set = new Set();
                        for(let i = 0; i < data.result.length; i++){
                            wiadomosci_id_set.add(data.result[i]['id_wiadomosc']);
                        }
                        for(let id_wiadomosc of wiadomosci_id_set){
                            temp_JSON = {
                                "id" : id_wiadomosc
                            }
                            listowanie_wiadomosci(temp_JSON);
                        }
					}
				}
			});

            function listowanie_wiadomosci(temp_JSON){
                $.ajax({
                    url: '/api/wiadomosci/pokaz',
                    type: "POST",
                    data: JSON.stringify(temp_JSON),
                    accept: "*/*",
                    contentType: "application/json; charset=UTF-8",
                    success: function (data) {
                        if (data.status != 200){
                            if (data.status == 401){
                                wyloguj();
                            }
                        } else if (data.status == 200){

							id_JSON = {
                                "id" : data.result['id_uzytkownik']
                            }
							jQuery.when(
								dane_uzytkownika(id_JSON)
							).done( function(json) {
								
								let date = new Date(data.result['data'] * 1000);
								if(date.getMonth() < 10){ month_append = 0; } else { month_append = ""; }
								if(date.getDate() < 10){ date_append = 0; } else { date_append = ""; }
								if(date.getHours() < 10){ hours_append = 0; } else { hours_append = ""; }
								if(date.getMinutes() < 10){ minutes_append = 0; } else { minutes_append = ""; }
								if(date.getSeconds() < 10){ seconds_append = 0; } else { seconds_append = ""; }
                   				let datestring = date.getFullYear()+"/"+month_append+(date.getMonth()+1)+"/"+date_append+date.getDate()+" "+hours_append+date.getHours()+":"+minutes_append+date.getMinutes()+":"+seconds_append+date.getSeconds();

								if ( data.result['id_uzytkownik'] == userdata.id ){
									wlasna = " style='background-color:#29163d' ";
								} else {
									wlasna = "";
								}

								$("#odpowiedzAJAX").append(
								"<tr"+wlasna+">"+
									"<td>"+data.result['id']+"</td>"+
									"<td>"+json.result['imie']+" "+json.result['nazwisko']+"</td>"+
									"<td>"+datestring+"</td>"+
									"<td>"+data.result['temat']+"</td>"+
									"<td><button onclick=\"szczegoly_wiadomosci(\'"+data.result['id']+"\',\'"+json.result['imie']+"\',\'"+json.result['nazwisko']+"\')\">Pokaż szczegóły</button></td>"+
								"</tr>"
                            	);
							});
                        }
                    }
                });
            }

			function dane_uzytkownika(id_JSON){
				return $.ajax({
                    url: '/api/uzytkownik/publiczne',
                    type: "POST",
                    data: JSON.stringify(id_JSON),
                    accept: "*/*",
                    contentType: "application/json; charset=UTF-8",
                });
			}

			$("#modalZamknij").click(function() {
				$("#modalWiadomosc").hide();
				$("#modalWiadomoscTytul").html("");
				$("#modalWiadomoscNadawca").html("");
				$("#modalWiadomoscData").html("");
				$("#modalWiadomoscTresc").html("");
			});

			function szczegoly_wiadomosci(id,imie,nazwisko){
				$("#modalWiadomosc").show();

				id_JSON = {
					"id" : parseInt(id)
				}

				jQuery.when(
					$.ajax({
						url: '/api/wiadomosci/pokaz',
						type: "POST",
						data: JSON.stringify(id_JSON),
						accept: "*/*",
						contentType: "application/json; charset=UTF-8",
                	})
				).done( function(data) {
					
					let date = new Date(data.result['data'] * 1000);
					if(date.getMonth() < 10){ month_append = 0; } else { month_append = ""; }
					if(date.getDate() < 10){ date_append = 0; } else { date_append = ""; }
					if(date.getHours() < 10){ hours_append = 0; } else { hours_append = ""; }
					if(date.getMinutes() < 10){ minutes_append = 0; } else { minutes_append = ""; }
					if(date.getSeconds() < 10){ seconds_append = 0; } else { seconds_append = ""; }
                    let datestring = date.getFullYear()+"/"+month_append+(date.getMonth()+1)+"/"+date_append+date.getDate()+" "+hours_append+date.getHours()+":"+minutes_append+date.getMinutes()+":"+seconds_append+date.getSeconds();

					$("#modalWiadomoscTytul").text(data.result['temat']);
					$("#modalWiadomoscNadawca").html("<b>Nadawca:</b> "+imie+" "+nazwisko);
					$("#modalWiadomoscData").html("<b>Data:</b> "+datestring);
					$("#modalWiadomoscTresc").html("<b>Treść:</b></br></br>"+data.result['dane']);
				});
			}
		</script>
	</body>
</html>