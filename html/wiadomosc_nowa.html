<!doctype html>
<html lang="pl">
	<head>
		<script src="/js/jquery.min.js"></script>
		<script src="/js/main.js"></script>
        <script src="/js/select2.min.js"></script>
		<script>
			if (getCookie("token") == null) {
				document.location.href = "/logowanie.html";
				document.body.innerHTML = "";
				window.stop();
			} else {
				var userdata = {
					"id" : parseInt(getCookie("id")),
					"id_uprawnien" : parseInt(getCookie("id_uprawnienie"))
				}

				if (userdata.id_uprawnien < 1){ // minimalny poziom uprawnień (zabezpieczenie api osobno)
					document.location.href = "/";
					document.body.innerHTML = "";
					window.stop();
				}
			}
		</script>
		<meta charset="utf-8">
		<title>System obsługi studentów</title>
		<meta name="description" content="System Obsługi Studentów">
		<link rel="stylesheet" href="/css/navbar.css">
        <link rel="stylesheet" href="/css/select2.min.css">
		<link rel="stylesheet" href="/css/main.css">
        <style>
            input {
                width: 500px;
                height: 30px;
                margin: 10px 0px 5px 0px;
            }
            textarea {
                width: 500px;
                height: 300px;
                margin: 5px 0px 5px 0px;
            }
            select {
                width: 506px;
                color: black;
                margin: 5px 0px 5px 0px;
            }
            .select2-results * {
                color: black;
            }
        </style>
	</head>
	<body>
		<div class="navbar">
			<a id="menu-strona" href="/">Strona główna</a>
			<div id="dropdown-wiadomosci" class="dropdown">
				<button class="dropbtn">
					<span>Wiadomości</span> 
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-wiadomosci-skrzynka" href="/wiadomosci.html"><span>Skrzynka odbiorcza</span></a>
					<a id="dropdown-wiadomosci-utworz" href="/wiadomosc_nowa.html"><span>Utwórz wiadomość</span></a>
				</div>
			</div>
			<div id="dropdown-ogloszenia" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie ogłoszeniami</span> 
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-ogloszenia-lista" href="#"><span class="disabled">Lista ogłoszeń</span></a>
					<a id="dropdown-ogloszenia-utworz" href="#"><span class="disabled">Utwórz nowe ogłoszenie</span></a>
				</div>
			</div>
			<div id="dropdown-uzytkownicy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie użytkownikami</span> 
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-uzytkownicy-lista" href="#"><span class="disabled">Lista użytkowników</span></a>
					<a id="dropdown-uzytkownicy-utworz" href="#"><span class="disabled">Utwórz użytkownika</span></a>
				</div>
			</div>
			<div id="dropdown-zapisy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie zapisami</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-zapisy-utworz" href="#"><span class="disabled">Tworzenie zapisów</span></a>
					<a id="dropdown-zapisy-edycja" href="#"><span class="disabled">Edycja zapisów</span></a>
				</div>
			</div>
			<a id="menu-zapisy" href="/"><span class="disabled">Zapisy</span></a>
			<div id="dropdown-kursyz" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzanie kursami</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-kursyz-lista" href="#"><span class="disabled">Lista kursów</span></a>
					<a id="dropdown-kursyz-utworz" href="#"><span class="disabled">Utwórz nowy kurs</span></a>
				</div>
			</div>
			<div id="dropdown-kursy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Kursy</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-kursy-zajecia" href="#"><span class="disabled">Zajęcia</span></a>
					<a id="dropdown-kursy-oceny" href="#"><span class="disabled">Oceny</span></a>
				</div>
			</div>
			<a id="menu-indeks" href="/"><span class="disabled">Indeks</span></a>
			<div id="dropdown-sprawy" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Sprawy</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-sprawy-moje" href="#"><span class="disabled">Moje sprawy</span></a>
					<a id="dropdown-sprawy-utworz" href="#"><span class="disabled">Załóż sprawę</span></a>
				</div>
			</div>
			<div id="dropdown-sprawyz" class="dropdown">
				<button class="dropbtn">
					<span class="disabled">Zarządzaj sprawami</span>
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a id="dropdown-sprawyz-lista" href="#"><span class="disabled">Przeglądaj sprawy</span></a>
					<a id="dropdown-sprawyz-utworz" href="#"><span class="disabled">Definiuj sprawy</span></a>
				</div>
			</div>
			<div class="dropdown-right">
				<button class="dropbtn">
					<span id="auth-imie">Imie</span> <span id="auth-nazwisko">Nazwisko</span> (<span id="auth-ranga">Ranga</span>)
					<i class="arrow down"></i>
				</button>
				<div class="dropdown-content">
					<a href="#"><span class="disabled">Dane osobowe</span></a>
					<a href="#"><span class="disabled">Ustawienia</span></a>
					<a id="wyloguj_navbar" href="/wyloguj.html">Wyloguj</a>
				</div>
			</div>
		</div>
		<div class="content">
			<div class="header">
				<h2>Tworzenie nowej wiadomości</h2>
			</div>
			<div>
                <select id="select_odbiorca" name="id_odbiorca">
                    <option value="-1" selected></option>
                </select></br>

                <input id="temat" placeholder="Temat"></input></br>
                <textarea id="dane"></textarea></br>
                <button id="wyslij_wiadomosc">Wyślij wiadomość</button>
            </div>
		</div>
		
		<script src="/js/nav.js"></script>
		<script>
            $(document).ready(function() {
                $("#select_odbiorca").select2();

				$.ajax({
					url: '/api/uzytkownicy',
					type: "POST",
					//data: JSON.stringify(uzytkownik_id),
					contentType: "application/json; charset=UTF-8",
					success: function (data) {
						if (data.status != 200){
							if (data.status == 401){
								wyloguj();
							}
						} else if (data.status == 200){
							for(let i = 0; i < data.result.length; i++){
								if (userdata.id != data.result[i]["id"]){
									$("#select_odbiorca").append(new Option(data.result[i]["imie"]+" "+data.result[i]["nazwisko"], data.result[i]["id"]));
								}
							}
						}
					}
				});
            });

			$("#wyslij_wiadomosc").click(function() {
				wiadomosc_dane = {
					"id_uzytkownik" : userdata.id,
					"temat" : $("#temat").val(),
					"dane" : $("#dane").val()
				}

				odbiorca = {
					"id_wiadomosc" : -1,
					"id_uczestnik" : parseInt($("#select_odbiorca").val())
				}

				if(wiadomosc_dane.temat != "" && wiadomosc_dane.dane != "" && odbiorca.id_uczestnik  != -1){
					wyslij_wiadomosc(wiadomosc_dane,odbiorca);
				} else {
					alert("błędna treść");
				}
			});

			function wyslij_wiadomosc(wiadomosc_dane,odbiorca){
				console.log(wiadomosc_dane);
				console.log(odbiorca);

				jQuery.when(
					$.ajax({
						url: '/api/wiadomosci/nowa',
						type: "POST",
						data: JSON.stringify(wiadomosc_dane),
						accept: "*/*",
						contentType: "application/json; charset=UTF-8",
                	})
				).done( function(data) {
					if (data.status != 200){
						if (data.status == 401){
							wyloguj();
						}
					} else if (data.status == 200){
						odbiorca.id_wiadomosc = data.result;
						console.log(odbiorca);
						$.ajax({
							url: '/api/wiadomosci/dodajodbiorce',
							type: "POST",
							data: JSON.stringify(odbiorca),
							contentType: "application/json; charset=UTF-8",
							success: function (data) {
								if (data.status != 200){
									if (data.status == 401){
										wyloguj();
									}
								} else if (data.status == 200){
									alert("Udało się wysłać wiadomość");
									document.location.href = "/wiadomosci.html";
								}
							}
						});
					}
				});
			}
		</script>
	</body>
</html>